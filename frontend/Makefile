.PHONY: run run_local format build deploy docker_build list

# https://hub.docker.com/_/node/
DOCKER_BASE_IMAGE = node:20.9.0-alpine3.18
FRONTEND_DEPLOY_TARGET_SSH_HOST_ = ${FRONTEND_DEPLOY_TARGET_SSH_HOST}
VITE_FRONTEND_BASE_URL_ = ${VITE_FRONTEND_BASE_URL}
VITE_FRONTEND_DATA_URL_ = ${VITE_FRONTEND_DATA_URL}

run:
	VITE_BASE_URL=http://localhost:5173/ \
	VITE_DB_URL=http://localhost:5173/data/db.sqlite3 \
	VITE_BLOBS_URL=http://localhost:5173/data/blobs \
		yarn run dev

run_local:
	# This requires some data in ../data.
	VITE_BASE_URL=http://localhost:5173/ \
	VITE_DB_URL=http://localhost:5173/_data/db.sqlite3 \
	VITE_BLOBS_URL=http://localhost:5173/_data/blobs \
		yarn run dev

format:
	yarn run format

build:
	test -n "$(VITE_FRONTEND_BASE_URL_)" # missing env var, please set up env file from env.example and source it
	test -n "$(VITE_FRONTEND_DATA_URL_)" # missing env var, please set up env file from env.example and source it
	VITE_BASE_URL=$(VITE_FRONTEND_BASE_URL_) \
	VITE_DB_URL=$(VITE_FRONTEND_DATA_URL_)/db.sqlite3 \
	VITE_BLOBS_URL=$(VITE_FRONTEND_DATA_URL_)/blobs \
		yarn run build

deploy: build #docker_build
	test -n "$(FRONTEND_DEPLOY_TARGET_SSH_HOST_)" # missing env var, please set up env file from env.example and source it
	rm -rf dist/_data
	chmod 755 dist/
	rsync --verbose --archive --compress --rsh=ssh --exclude=data dist/ $(FRONTEND_DEPLOY_TARGET_SSH_HOST_)

DOCKER_FLAGS = $(DOCKER_CLI_FLAGS)
DOCKER_FLAGS += --build-arg DOCKER_BASE_IMAGE="$(DOCKER_BASE_IMAGE)"

docker_build:
	docker buildx build $(DOCKER_FLAGS)     \
		--target=export              \
		--output=dist                \
		.

list:
	@LC_ALL=C $(MAKE) -pRrq -f $(firstword $(MAKEFILE_LIST)) : 2>/dev/null | awk -v RS= -F: '/(^|\n)# Files(\n|$$)/,/(^|\n)# Finished Make data base/ {if ($$1 !~ "^[#.]") {print $$1}}' | sort | grep -E -v -e '^[^[:alnum:]]' -e '^$@$$'
